---
title: "Data Visualization Dashboard"
logo: assets/city-of-norfolk.png
format: dashboard

theme: 
  - cosmo
  - assets/styles/custom.scss
  - assets/styles/quarto.scss

execute: 
  echo: false
---

```{r setup, include = FALSE}
library(dplyr)
library(ggplot2)
library(forcats)
```

```{r}
library(haven)
data <- read_spss("/Users/nelliechen/Desktop/IDA meeting/ELS variable undated 2.13.21.sav")
library(readr)

els <- data[, c("STU_ID", "SCH_ID", "F1S18A", "F1S18B", "F1S18C", "F1S18D",
                "F1S18E", "Male", "SES_Grp", "Asian", "Black", "Hispanic", "Other")]

els_labs <- c("stu_id", "sch_id", "excellentTests", "understandTexts", "understandClass",
              "excellentAssign", "masterSkills",  "Male", "SES_Grp", "Asian", "Black", "Hispanic", "Other")
colnames(els) <- els_labs
```

# ELS
## Row {height=40%}
### Column {.tabset width="70%"}
```{r} 
#| title: Excellent Test
library(tidyr)
library(dplyr)
library(ggplot2)

# bar graph for each item
# excellent test 
library(ggplot2)
library(dplyr)

# Calculate mean and median
mean_value <- mean(els$excellentTests, na.rm = TRUE)
median_value <- median(els$excellentTests, na.rm = TRUE)

# Create the bar graph
ggplot(els, aes(x = as.factor(excellentTests))) + 
  geom_bar(fill = "darkseagreen3", color = "darkseagreen3") +
  labs(title = "Bar Graph of Excellent Test Scores", 
       x = "Excellent Test Scores", 
       y = "Count") +
  geom_text(aes(label = ..count..), stat = 'count', position = position_stack(vjust = 0.5), color = "white") + # Add count labels
  annotate("text", x = Inf, y = Inf, label = paste("Mean:", round(mean_value, 2)), hjust = 1.1, vjust = 2, size = 4, color = "black") + # Add mean label
  annotate("text", x = Inf, y = Inf, label = paste("Median:", median_value), hjust = 1.1, vjust = 1, size = 4, color = "black") # Add median label
```

```{r} 
#| title: Understand Text
library(ggplot2)
library(dplyr)

# Calculate mean and median for understandTexts
mean_understandTexts <- mean(els$understandTexts, na.rm = TRUE)
median_understandTexts <- median(els$understandTexts, na.rm = TRUE)

# Create the bar graph for understandTexts
ggplot(els, aes(x = as.factor(understandTexts))) + 
  geom_bar(fill = "darkseagreen3", color = "darkseagreen3") +
  labs(title = "Bar Graph of Understanding Texts Scores", 
       x = "Understanding Texts Scores", 
       y = "Count") +
  geom_text(aes(label = ..count..), stat = 'count', position = position_stack(vjust = 0.5), color = "white") +
  annotate("text", x = Inf, y = Inf, label = paste("Mean:", round(mean_understandTexts, 2)), hjust = 1.1, vjust = 2, size = 4, color = "black") +
  annotate("text", x = Inf, y = Inf, label = paste("Median:", median_understandTexts), hjust = 1.1, vjust = 1, size = 4, color = "black")
```

```{r}
#| title: Understand Class
# Calculate mean and median for understandClass
mean_understandClass <- mean(els$understandClass, na.rm = TRUE)
median_understandClass <- median(els$understandClass, na.rm = TRUE)

# Create the bar graph for understandClass
ggplot(els, aes(x = as.factor(understandClass))) + 
  geom_bar(fill = "darkseagreen3", color = "darkseagreen3") +
  labs(title = "Bar Graph of Understanding Class Material Scores", 
       x = "Understanding Class Material Scores", 
       y = "Count") +
  geom_text(aes(label = ..count..), stat = 'count', position = position_stack(vjust = 0.5), color = "white") +
  annotate("text", x = Inf, y = Inf, label = paste("Mean:", round(mean_understandClass, 2)), hjust = 1.1, vjust = 2, size = 4, color = "black") +
  annotate("text", x = Inf, y = Inf, label = paste("Median:", median_understandClass), hjust = 1.1, vjust = 1, size = 4, color = "black")
```

```{r}
#| title: Excellent Assignment
# Calculate mean and median for excellentAssign
mean_excellentAssign <- mean(els$excellentAssign, na.rm = TRUE)
median_excellentAssign <- median(els$excellentAssign, na.rm = TRUE)

# Create the bar graph for excellentAssign
ggplot(els, aes(x = as.factor(excellentAssign))) + 
  geom_bar(fill = "darkseagreen3", color = "darkseagreen3") +
  labs(title = "Bar Graph of Excellent Assignment Scores", 
       x = "Excellent Assignment Scores", 
       y = "Count") +
  geom_text(aes(label = ..count..), stat = 'count', position = position_stack(vjust = 0.5), color = "white") +
  annotate("text", x = Inf, y = Inf, label = paste("Mean:", round(mean_excellentAssign, 2)), hjust = 1.1, vjust = 2, size = 4, color = "black") +
  annotate("text", x = Inf, y = Inf, label = paste("Median:", median_excellentAssign), hjust = 1.1, vjust = 1, size = 4, color = "black")
```

```{r}
#| title: Master Skills
# Calculate mean and median for masterSkills
mean_masterSkills <- mean(els$masterSkills, na.rm = TRUE)
median_masterSkills <- median(els$masterSkills, na.rm = TRUE)

# Create the bar graph for masterSkills
ggplot(els, aes(x = as.factor(masterSkills))) + 
  geom_bar(fill = "darkseagreen3", color = "darkseagreen3") +
  labs(title = "Bar Graph of Mastering Skills Scores", 
       x = "Mastering Skills Scores", 
       y = "Count") +
  geom_text(aes(label = ..count..), stat = 'count', position = position_stack(vjust = 0.5), color = "white") +
  annotate("text", x = Inf, y = Inf, label = paste("Mean:", round(mean_masterSkills, 2)), hjust = 1.1, vjust = 2, size = 4, color = "black") +
  annotate("text", x = Inf, y = Inf, label = paste("Median:", median_masterSkills), hjust = 1.1, vjust = 1, size = 4, color = "black")
```


```{r}
#| title: Stacked Bar Graph
els_long <- els %>%
  pivot_longer(
    cols = c(excellentTests, understandTexts, understandClass, excellentAssign, masterSkills),
    names_to = "ScoreType",
    values_to = "Scores"
  )
els_long_filtered <- els_long %>%
  filter(!is.na(Scores)) # Removes rows where Scores is NA

library(ggplot2)

ggplot(els_long_filtered, aes(x = ScoreType, fill = as.factor(Scores))) + 
  geom_bar(position = "stack") + 
  geom_text(stat = 'count', aes(label = ..count..), position = position_stack(vjust = 0.5), size = 3) +
  labs(title = "Frequency of Scores by Score Type", 
       x = "Score Type", 
       y = "Frequency") +
    scale_fill_brewer(palette = "Set4") +
    theme_minimal()
```
### Column
```{r pie chart}
#| title: Ethnicity Distribution
library(dplyr)
library(ggplot2)
library(tidyr) # Ensure tidyr is loaded for pivot_longer

# Calculate the total counts for each category
category_counts <- els %>%
  summarise(Asian = sum(Asian, na.rm = TRUE),
            Black = sum(Black, na.rm = TRUE),
            Hispanic = sum(Hispanic, na.rm = TRUE),
            Other = sum(Other, na.rm = TRUE)) %>%
  pivot_longer(cols = everything(), names_to = "Category", values_to = "Counts")

# Calculate percentages
total_counts <- sum(category_counts$Counts)
category_counts <- category_counts %>%
  mutate(Percentage = Counts / total_counts * 100)

ggplot(category_counts, aes(x = "", y = Counts, fill = Category)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0) +
  geom_text(aes(label = paste(Category, ": ", Counts, " (", sprintf("%.1f%%", Percentage), ")", sep = "")),
            position = position_stack(vjust = 0.5)) +
  labs(title = "Distribution of Ethnicity", x = NULL, y = NULL, fill = "Category") +
  scale_fill_brewer(palette = "Pastel1") +
  theme_void() +
  theme(legend.position = "none")
```


## Row 
### Column {.tabset width="70%"}

```{r Overall}
#| title: Overall Ratings 

```


```{r Grouped by Gender}
#| title: Ratings Grouped by Gender

library(ggplot2)
library(dplyr)
library(tidyr)
els_long <- els %>%
  pivot_longer(cols = c("excellentTests", "understandTexts", "understandClass", "excellentAssign", "masterSkills"),
               names_to = "Test", values_to = "Score") %>%
  mutate(Male = factor(Male, labels = c("Female", "Male")))
ggplot(els_long, aes(x = Test, fill = factor(Score), group = interaction(Test, Score, Male))) + 
  geom_bar(position = position_dodge(width = 0.9), stat = "count", aes(y = ..count..)) +
  geom_text(stat = 'count', aes(label = ..count.., y = ..count.., group = interaction(Test, Score, Male)),
            position = position_dodge(width = 0.9), vjust = -0.25,size=2.5) +
  facet_wrap(~Male, scales = "free_x") +
  labs(title = "Frequency of Scores by Test and Gender",
       x = "Test", y = "Frequency", fill = "Score") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_brewer(palette = "Blues")
```

```{r Grouped by Ethnicity}
#| title: Ratings Grouped by Ethnicity
# grouped by ethnicity
library(ggplot2)
library(dplyr)
library(tidyr)
library(forcats)
library(patchwork)

# Assuming 'els' is your original dataset
# First, reshape the data
els_long <- els %>%
  pivot_longer(cols = c("excellentTests", "understandTexts", "understandClass", "excellentAssign", "masterSkills"),
               names_to = "Test", values_to = "Score")

# Add an Ethnicity column based on the binary flags
els_long <- els_long %>%
  mutate(Ethnicity = case_when(
    Asian == 1 ~ "Asian",
    Black == 1 ~ "Black",
    Hispanic == 1 ~ "Hispanic",
    Other == 1 ~ "Other",
    TRUE ~ NA_character_ # Use NA for rows that do not match any condition
  )) %>%
  filter(!is.na(Ethnicity)) # Remove rows without a specified ethnicity

# Function to plot for a given ethnic group
plot_for_ethnic_group <- function(data, group) {
  filtered_data <- data %>% filter(Ethnicity == group)
  ggplot(filtered_data, aes(x = Test, fill = factor(Score), group = interaction(Test, Score))) + 
    geom_bar(position = position_dodge(width = 0.5), stat = "count", aes(y = ..count..)) +
    geom_text(stat = 'count', aes(label = ..count.., y = ..count.., group = interaction(Test, Score)),
              position = position_dodge(width = 0.5), vjust = -0.25, size = 1.5) +
    labs(title = paste("Frequency of Scores by Test among", group, "Students"),
         x = "Test", y = "Frequency", fill = "Score") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    scale_fill_brewer(palette = "Blues")
}

# Plot for each ethnic group
ethnic_groups <- c("Asian", "Black", "Hispanic", "Other")
plots <- lapply(ethnic_groups, function(group) plot_for_ethnic_group(els_long, group))


plot_asian <- plots[[1]]+
  theme(plot.title = element_text(size = 8), axis.title.x = element_text(size = 8), 
    axis.title.y = element_text(size = 8),legend.text = element_text(size = 8),legend.title = element_text(size = 8),legend.key.size = unit(0.3, "cm"))
plot_black <- plots[[2]]+
  theme(plot.title = element_text(size = 8), axis.title.x = element_text(size = 8), 
    axis.title.y = element_text(size = 8) ,legend.text = element_text(size = 8),legend.title = element_text(size = 8),legend.key.size = unit(0.3, "cm") )
plot_hispanic <- plots[[3]]+
  theme(plot.title = element_text(size = 8), axis.title.x = element_text(size = 8), 
    axis.title.y = element_text(size = 8),legend.text = element_text(size = 8),legend.title = element_text(size = 8),legend.key.size = unit(0.3, "cm")  )
plot_other <- plots[[4]]+
  theme(plot.title = element_text(size =8), axis.title.x = element_text(size = 8), 
    axis.title.y = element_text(size = 8),legend.text = element_text(size = 8) ,legend.title = element_text(size = 8),legend.key.size = unit(0.3, "cm") )

# Combine the plots
combined_plot <- plot_asian + plot_black + plot_hispanic + plot_other + 
  plot_layout(ncol = 2) # Arrange in 2 columns (adjust as needed)

combined_plot

ggsave("combined_ethnic_groups_plot.png", combined_plot, width = 20, height = 10) 

```
### Column {width = 30%}
```{r 2}
#| title: Gender Distribution
library(ggplot2)
# Pie Chart
ggplot(els, aes(x = "", fill = factor(Male))) + 
  geom_bar(width = 1, stat = "count") +
  coord_polar(theta = "y") +
  geom_text(aes(label = paste(round((..count..)/sum(..count..)*100, 1), "%")), 
            stat = 'count', position = position_stack(vjust = 0.5)) +
  scale_fill_manual(values = c("0" = "lightskyblue2", "1" = "mintcream"),
                    labels = c("Female", "Male"), name = "Gender") +
  labs(title = "Gender Distribution", x = NULL, y = NULL)

```




# HSLS

